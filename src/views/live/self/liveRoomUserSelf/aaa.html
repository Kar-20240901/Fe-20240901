<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <body>
    <video id="111" controls autoplay></video>
  </body>

  <script>
    function Base64ToUint8Array(base64) {
      // 解码 Base64 字符串
      const binaryString = atob(base64);
      // 创建 Uint8Array 数组
      const uint8Array = new Uint8Array(binaryString.length);
      // 填充数组
      for (let i = 0; i < binaryString.length; i++) {
        uint8Array[i] = binaryString.charCodeAt(i);
      }
      return uint8Array;
    }

    var stream;

    startCameraAndStream();

    function handleBlob(sourceBuffer, blob) {
      return new Promise(resolve => {
        const reader = new FileReader();

        reader.onerror = () => {
          reject(new Error("读取 Blob 时出错"));
        };

        reader.onload = e => {
          const result = e.target.result;

          // console.log(`result-${new Date().getTime()}：`, result);

          let base64Str = result.replace(/^data:.*?;base64,/, "");

          console.log(`base64Str-${new Date().getTime()}：`, base64Str);

          const uint8Array = Base64ToUint8Array(base64Str);

          sourceBuffer.appendBuffer(uint8Array);
          resolve();
        };

        // reader.readAsArrayBuffer(blob);
        reader.readAsDataURL(blob);
      });
    }

    function startCameraAndStream() {
      if (stream) {
        return;
      }

      navigator.mediaDevices
        .getUserMedia({
          audio: true,
          video: { frameRate: 30 }
        })
        .then(
          streamTemp => {
            var mediaRecorder;

            var sourceBuffer;

            stream = streamTemp;

            const ele = document.getElementById("111");

            const mediaSource = new MediaSource();
            ele.src = URL.createObjectURL(mediaSource);

            // ele.play();

            mediaSource.onsourceopen = () => {
              const mimeType = "video/webm; codecs=vp9,opus";
              sourceBuffer = mediaSource.addSourceBuffer(mimeType);
            };

            mediaRecorder = new window.MediaRecorder(stream, {
              videoBitsPerSecond: 1000000,
              audioBitsPerSecond: 64000,
              mimeType: "video/webm; codecs=vp9,opus"
            });

            var curr = 0;

            var firstBlobArr = [];

            mediaRecorder.ondataavailable = async function (e) {
              curr = curr + 1;

              if (curr >= 20) {
                return;
              }

              if (curr <= 2) {
                firstBlobArr.push(e.data);
              }

              // 如果 sourceBuffer 正在更新，等待更新完成
              if (sourceBuffer && sourceBuffer.updating) {
                console.log("SourceBuffer is updating, waiting...");
                return;
              }

              if (sourceBuffer) {
                if (firstBlobArr && firstBlobArr.length) {
                  var firstBlobArrTemp = [...firstBlobArr];

                  firstBlobArr = [];

                  firstBlobArrTemp.forEach(async item => {
                    await handleBlob(sourceBuffer, item);
                  });
                }

                await handleBlob(sourceBuffer, e.data);
              }
            };

            mediaRecorder.start(100);
          },
          () => {
            console.error("出错，请确保已允许浏览器获取音视频权限");
          }
        );
    }
  </script>
</html>
