<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <body>
    <video id="111" controls autoplay></video>
  </body>

  <script>
    var stream;

    startCameraAndStream();

    function handleBlob(sourceBuffer, blob) {
      return new Promise(resolve => {
        const reader = new FileReader();

        reader.onerror = () => {
          reject(new Error("读取 Blob 时出错"));
        };

        reader.onload = e => {
          // debugger
          sourceBuffer.appendBuffer(e.target.result);
          resolve();
        };

        reader.readAsArrayBuffer(blob);
      });
    }

    function startCameraAndStream() {
      if (stream) {
        return;
      }

      navigator.mediaDevices
        .getUserMedia({
          audio: true,
          video: { frameRate: 30 }
        })
        .then(
          streamTemp => {
            var mediaRecorder;

            var sourceBuffer;

            stream = streamTemp;

            const ele = document.getElementById("111");

            const mediaSource = new MediaSource();
            ele.src = URL.createObjectURL(mediaSource);

            // ele.play();

            mediaSource.onsourceopen = () => {
              const mimeType = "video/webm; codecs=vp9,opus";
              sourceBuffer = mediaSource.addSourceBuffer(mimeType);
            };

            mediaRecorder = new window.MediaRecorder(stream, {
              videoBitsPerSecond: 1000000,
              audioBitsPerSecond: 64000,
              mimeType: "video/webm; codecs=vp9,opus"
            });

            var curr = 0;

            var firstBlobArr = [];

            mediaRecorder.ondataavailable = async function (e) {
              console.log(
                `数据${e.data.size > 12 * 10000 ? "丢失" : ""}：`,
                e.data
              );

              curr = curr + 1;

              if (curr <= 10) {
                if (curr <= 2) {
                  firstBlobArr.push(e.data);
                }

                return;
              }

              // 如果 sourceBuffer 正在更新，等待更新完成
              if (sourceBuffer && sourceBuffer.updating) {
                console.log("SourceBuffer is updating, waiting...");
                return;
              }

              if (sourceBuffer) {
                if (firstBlobArr && firstBlobArr.length) {
                  var firstBlobArrTemp = [...firstBlobArr];

                  firstBlobArr = [];

                  firstBlobArrTemp.forEach(async item => {
                    await handleBlob(sourceBuffer, item);
                  });

                  // const uint8Array = new Uint8Array(
                  //   [26, 69, 223, 163, 159, 66, 134, 129, 1, 66, 247, 129, 1, 66, 242, 129, 4, 66, 243,
                  //     129, 8, 66, 130, 132, 119, 101, 98, 109, 66, 135, 129, 4, 66, 133, 129, 2, 24, 83,
                  //     128, 103, 1, 255, 255, 255, 255, 255, 255, 255, 21, 73, 169, 102, 153, 42, 215,
                  //     177, 131, 15, 66, 64, 77, 128, 134, 67, 104, 114, 111, 109, 101, 87, 65, 134, 67,
                  //     104, 114, 111, 109, 101, 22, 84, 174, 107, 253, 174, 189, 215, 129, 1, 115, 197,
                  //     135]);
                  //
                  // const firstBlob = new Blob([uint8Array]);
                  //
                  // await handleBlob(sourceBuffer, firstBlob);
                }

                handleBlob(sourceBuffer, e.data);
              }
            };

            mediaRecorder.start(200);
          },
          () => {
            console.error("出错，请确保已允许浏览器获取音视频权限");
          }
        );
    }
  </script>
</html>
